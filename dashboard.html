<!DOCTYPE html>
<html>
<head>
    <title>Photo Dedup Tool - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='3' y='5' width='18' height='14' rx='2' fill='%23e0e0e0' stroke='%23999' stroke-width='1'/%3E%3Crect x='3' y='5' width='18' height='2' fill='%23999'/%3E%3Crect x='5' y='8' width='3' height='2' rx='1' fill='%23666'/%3E%3Ccircle cx='16' cy='12' r='2' fill='%23666'/%3E%3Crect x='11' y='13' width='18' height='14' rx='2' fill='%23fff' stroke='%23666' stroke-width='1'/%3E%3Crect x='11' y='13' width='18' height='2' fill='%23666'/%3E%3Crect x='13' y='16' width='3' height='2' rx='1' fill='%23333'/%3E%3Ccircle cx='24' cy='20' r='2' fill='%23333'/%3E%3C/svg%3E">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 32px;
            background: white;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            color: #6c757d;
            font-size: 1.2rem;
            margin: 40px 0;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stats-overview {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            text-align: center;
            padding: 24px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .priority-section {
            margin-bottom: 32px;
            background: white;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .priority-bucket {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 24px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        
        .priority-bucket:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: white;
        }
        
        .priority-bucket.high {
            border-left: 5px solid #dc3545;
        }
        
        .priority-bucket.medium {
            border-left: 5px solid #ffc107;
        }
        
        .priority-bucket.low {
            border-left: 5px solid #28a745;
        }
        
        .priority-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .priority-icon {
            font-size: 1.5rem;
            margin-right: 8px;
        }
        
        .priority-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .priority-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .priority-stat {
            text-align: center;
        }
        
        .priority-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .priority-stat-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .analyze-btn {
            width: 100%;
            padding: 12px 24px;
            border: 1px solid #667eea;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .analyze-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .footer {
            text-align: center;
            color: #6c757d;
            margin-top: 40px;
            opacity: 0.8;
        }
        
        .legacy-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 8px;
            margin-top: 24px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .legacy-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #f5c6cb;
        }
        
        .cameras-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .cameras-list h4 {
            margin-bottom: 10px;
            color: #666;
        }
        
        .cameras-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .camera-tag {
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>Photo Dedup Dashboard</h1>
            <p>Smart photo duplicate detection with priority targeting</p>
        </header>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            Analyzing your photo library...
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <section class="stats-overview">
                <h2 style="margin-bottom: 20px; text-align: center;">üìä Library Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-photos">-</div>
                        <div class="stat-label">Total Photos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="library-size">-</div>
                        <div class="stat-label">Library Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="estimated-duplicates">-</div>
                        <div class="stat-label">Est. Duplicates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="potential-savings">-</div>
                        <div class="stat-label">Est. Savings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="date-range">-</div>
                        <div class="stat-label">Date Range</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="cluster-count">-</div>
                        <div class="stat-label">Photo Clusters</div>
                    </div>
                </div>
                
                <div class="cameras-list">
                    <h4>üì∑ Camera Models in Library</h4>
                    <div id="cameras-tags" class="cameras-tags"></div>
                </div>
            </section>
            
            <!-- Analysis Controls Section -->
            <section class="analysis-controls" style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; margin: 24px 0; backdrop-filter: blur(10px);">
                <h2 style="margin-bottom: 20px; text-align: center; color: white;">üéØ Smart Analysis Controls</h2>
                
                <!-- File Size Filter -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 16px;">üíæ Focus on Larger Files</h3>
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 12px;">
                        <label style="color: white; min-width: 120px;">Min File Size:</label>
                        <input type="range" id="size-slider" min="0" max="20" value="5" 
                               style="flex: 1; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px;" />
                        <span id="size-value" style="color: white; font-weight: bold; min-width: 60px;">5 MB</span>
                    </div>
                    <div id="filter-preview" style="color: #a8d5ff; font-size: 14px; margin-top: 8px;"></div>
                </div>
                
                <!-- Analysis Type Selector -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 16px;">üîç Analysis Method</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="analysis-type-btn" data-type="metadata" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Fast (Metadata Only)</button>
                        <button class="analysis-type-btn" data-type="smart" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Smart (Skip Quality Analysis)</button>
                    </div>
                    <div style="color: #a8d5ff; font-size: 14px; margin-top: 8px;" id="analysis-description">
                        Fast grouping of largest files first - finds biggest space savings across entire library
                    </div>
                </div>
                
                <!-- Start Analysis Button -->
                <div style="text-align: center;">
                    <button id="start-analysis" class="analyze-btn" style="background: #28a745; color: white; padding: 12px 32px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
                        üöÄ Start Smart Analysis
                    </button>
                    <div id="analysis-preview" style="color: #a8d5ff; font-size: 14px; margin-top: 12px;"></div>
                </div>

                <!-- Detailed Progress Log -->
                <div id="progress-log-container" style="display: none; margin-top: 24px; background: rgba(44, 62, 80, 0.8); border: 1px solid #576574; border-radius: 8px; padding: 16px;">
                    <h3 style="color: #fff; margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center;">
                        <span style="color: #28a745; margin-right: 8px;">üìÑ</span>
                        Analysis Progress Log
                        <span id="progress-items-counter" style="margin-left: auto; font-size: 12px; color: #a8d5ff;"></span>
                    </h3>
                    <div id="progress-log" style="background: #1a252f; border-radius: 4px; padding: 12px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; color: #e8e8e8; line-height: 1.4;">
                        <!-- Progress log entries will appear here -->
                    </div>
                </div>
            </section>
            
            <section class="priority-section" id="priority-results" style="display: none;">
                <h2 style="margin-bottom: 20px; text-align: center; color: white;">üéØ Analysis Results</h2>
                <div class="priority-grid" id="priority-grid">
                    <!-- Priority buckets will be generated dynamically -->
                </div>
                
                <!-- Album Creation Section -->
                <div class="album-creation-section" style="margin-top: 32px; text-align: center; padding: 20px; background: rgba(44, 62, 80, 0.6); border-radius: 12px; border: 1px solid #576574;">
                    <h3 style="color: #fff; margin: 0 0 16px 0; font-size: 18px;">
                        üìÅ Create Deletion Album
                    </h3>
                    <p style="color: #a8d5ff; margin: 0 0 16px 0; font-size: 14px;">
                        Create a Photos album with all recommended photos for easy deletion
                    </p>
                    <button id="create-album-btn" class="analyze-btn" style="background: #e67e22; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; margin-right: 12px;">
                        üìÅ Create Album
                    </button>
                    <button id="create-album-custom-btn" class="analyze-btn" style="background: #f39c12; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer;">
                        üìÅ Custom Album Name
                    </button>
                    <div id="album-status" style="margin-top: 12px; font-size: 14px; color: #a8d5ff;"></div>
                </div>
            </section>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <footer class="footer">
            <p>üéØ Start with high priority areas for maximum impact</p>
            <p>üí° Each session analyzes up to 10 groups to prevent fatigue</p>
            <a href="/legacy" class="legacy-link">Switch to Legacy View</a>
        </footer>
    </div>

    <script>
        let dashboardData = null;
        let analysisType = 'metadata';
        let minFileSizeMB = 5;
        
        async function loadDashboard() {
            try {
                // First check if we have a filter session (filtered mode)
                console.log('Checking for filter session...');
                const sessionResponse = await fetch('/api/get-filter-session');
                const sessionData = await sessionResponse.json();
                
                if (sessionData.success && sessionData.has_session && sessionData.mode === 'filtered') {
                    console.log('üìä Loading dashboard in FILTERED mode:', sessionData.filter_session);
                    await loadFilteredDashboard(sessionData.filter_session);
                } else {
                    console.log('üìä Loading dashboard in OVERVIEW mode');
                    await loadOverviewDashboard();
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError(`Failed to load dashboard: ${error.message}`);
            }
        }
        
        async function loadFilteredDashboard(filterSession) {
            try {
                console.log('üéØ Filtered analysis mode activated');
                console.log('Filter criteria:', filterSession.filter_criteria);
                console.log('Selected clusters:', filterSession.total_clusters_in_filter);
                
                // Load library stats
                const response = await fetch('/api/library-stats');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
                dashboardData = { 
                    library_stats: data.stats,
                    filter_session: filterSession,
                    mode: 'filtered'
                };
                
                updateFilteredDashboardUI();
                setupFilteredAnalysisControls();
                
            } catch (error) {
                console.error('Error loading filtered dashboard:', error);
                showError(`Failed to load filtered dashboard: ${error.message}`);
            }
        }
        
        async function loadOverviewDashboard() {
            try {
                console.log('Loading basic library stats...');
                const response = await fetch('/api/library-stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
                dashboardData = { 
                    library_stats: data.stats,
                    mode: 'overview'
                };
                
                updateDashboardUI();
                setupAnalysisControls();
                
            } catch (error) {
                console.error('Error loading overview dashboard:', error);
                showError(`Failed to load dashboard: ${error.message}`);
            }
        }
        
        function updateDashboardUI() {
            if (!dashboardData || !dashboardData.library_stats) return;
            
            const stats = dashboardData.library_stats;
            
            // Update library stats
            document.getElementById('total-photos').textContent = stats.total_photos.toLocaleString();
            document.getElementById('library-size').textContent = stats.total_size_gb ? `${stats.total_size_gb.toFixed(1)} GB` : 'Calculating...';
            document.getElementById('estimated-duplicates').textContent = (stats.estimated_duplicates || 'Run analysis');
            document.getElementById('potential-savings').textContent = (stats.potential_savings_gb && typeof stats.potential_savings_gb === 'number') ? `~${stats.potential_savings_gb.toFixed(1)} GB` : 'Run analysis';
            
            if (stats.date_range_start && stats.date_range_end) {
                const startYear = new Date(stats.date_range_start).getFullYear();
                const endYear = new Date(stats.date_range_end).getFullYear();
                document.getElementById('date-range').textContent = `${startYear}-${endYear}`;
            } else {
                document.getElementById('date-range').textContent = 'All dates';
            }
            
            document.getElementById('cluster-count').textContent = (stats.potential_groups || 'Run analysis');
            
            // Update cameras if available
            if (stats.camera_models && stats.camera_models.length > 0) {
                const camerasContainer = document.getElementById('cameras-tags');
                camerasContainer.innerHTML = '';
                stats.camera_models.forEach(camera => {
                    const tag = document.createElement('div');
                    tag.className = 'camera-tag';
                    tag.textContent = camera || 'Unknown';
                    camerasContainer.appendChild(tag);
                });
            }
        }
        
        function updateFilteredDashboardUI() {
            if (!dashboardData || !dashboardData.filter_session) return;
            
            const filterSession = dashboardData.filter_session;
            const stats = dashboardData.library_stats;
            
            // Update header to indicate filtered mode
            const headerTitle = document.querySelector('.header h1');
            const headerDesc = document.querySelector('.header p');
            headerTitle.innerHTML = 'üìä Filtered Analysis Dashboard';
            headerDesc.innerHTML = `Analyzing ${filterSession.total_clusters_in_filter} targeted clusters from your library`;
            
            // Update overview section title
            const overviewTitle = document.querySelector('.stats-overview h2');
            overviewTitle.innerHTML = 'üéØ Filtered Analysis Overview';
            
            // Update library stats with filtered context
            document.getElementById('total-photos').textContent = filterSession.total_photos_in_filter.toLocaleString() + ' (filtered)';
            document.getElementById('library-size').textContent = 'Filtered subset';
            document.getElementById('estimated-duplicates').textContent = filterSession.total_clusters_in_filter + ' selected';
            document.getElementById('potential-savings').textContent = 'To be calculated';
            
            if (stats.date_range_start && stats.date_range_end) {
                const startYear = new Date(stats.date_range_start).getFullYear();
                const endYear = new Date(stats.date_range_end).getFullYear();
                document.getElementById('date-range').textContent = `${startYear}-${endYear}`;
            } else {
                document.getElementById('date-range').textContent = 'All dates';
            }
            
            document.getElementById('cluster-count').textContent = filterSession.total_clusters_in_filter + ' targeted';
            
            // Add filter criteria display
            if (filterSession.filter_criteria) {
                const criteria = filterSession.filter_criteria;
                let criteriaText = 'Active filters: ';
                
                if (criteria.start_year && criteria.end_year) {
                    criteriaText += `${criteria.start_year}-${criteria.end_year}, `;
                } else if (criteria.year) {
                    criteriaText += `Year ${criteria.year}, `;
                }
                if (criteria.file_types && criteria.file_types.length > 0) {
                    criteriaText += `${criteria.file_types.join(', ')}, `;
                }
                if (criteria.min_size_mb) {
                    criteriaText += `‚â•${criteria.min_size_mb}MB, `;
                }
                if (criteria.priority_levels && criteria.priority_levels.length > 0) {
                    criteriaText += `Priority: ${criteria.priority_levels.join(', ')}, `;
                }
                
                criteriaText = criteriaText.replace(/, $/, '');
                
                // Add filter display below overview
                const statsOverview = document.querySelector('.stats-overview');
                let filterDisplay = document.getElementById('filter-criteria-display');
                if (!filterDisplay) {
                    filterDisplay = document.createElement('div');
                    filterDisplay.id = 'filter-criteria-display';
                    filterDisplay.style.cssText = 'background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 16px; margin-top: 20px; color: #0c5460;';
                    statsOverview.appendChild(filterDisplay);
                }
                filterDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 18px;">üéØ</span>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Filtered Analysis Mode</div>
                            <div style="font-size: 13px;">${criteriaText}</div>
                        </div>
                        <button onclick="clearFilterSession()" style="margin-left: auto; background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Clear Filters</button>
                    </div>
                `;
            }
            
            // Update cameras if available
            if (stats.camera_models && stats.camera_models.length > 0) {
                const camerasContainer = document.getElementById('cameras-tags');
                camerasContainer.innerHTML = '';
                stats.camera_models.forEach(camera => {
                    const tag = document.createElement('div');
                    tag.className = 'camera-tag';
                    tag.textContent = camera || 'Unknown';
                    camerasContainer.appendChild(tag);
                });
            }
        }
        
        function setupFilteredAnalysisControls() {
            // Update analysis controls title to reflect filtered mode
            const controlsTitle = document.querySelector('.analysis-controls h2');
            controlsTitle.innerHTML = 'üéØ Filtered Analysis Controls';
            
            // Update analysis description to reflect we're working with filtered data
            const analysisDescription = document.getElementById('analysis-description');
            analysisDescription.innerHTML = 'Analyzing selected clusters from filter criteria - focusing on targeted portion of library';
            
            // Set up controls similar to overview mode but with filtered context
            setupAnalysisControls();
            
            // Modify the start analysis button text
            const startBtn = document.getElementById('start-analysis');
            startBtn.innerHTML = 'üöÄ Analyze Selected Clusters';
            
            // Update analysis preview text
            const previewDiv = document.getElementById('analysis-preview');
            if (dashboardData.filter_session) {
                previewDiv.innerHTML = `Will analyze ${dashboardData.filter_session.total_clusters_in_filter} clusters from filtered selection`;
            }
        }
        
        function clearFilterSession() {
            if (confirm('This will clear your current filter selection and return to overview mode. Continue?')) {
                fetch('/api/clear-filter-session', { method: 'POST' })
                    .then(() => {
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error clearing filter session:', error);
                        alert('Error clearing filter session');
                    });
            }
        }
        
        function setupAnalysisControls() {
            const sizeSlider = document.getElementById('size-slider');
            const sizeValue = document.getElementById('size-value');
            const filterPreview = document.getElementById('filter-preview');
            
            // Size slider handler
            sizeSlider.addEventListener('input', async (e) => {
                minFileSizeMB = parseFloat(e.target.value);
                sizeValue.textContent = minFileSizeMB + ' MB';
                await updateFilterPreview();
            });
            
            // Analysis type buttons
            document.querySelectorAll('.analysis-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.analysis-type-btn').forEach(b => {
                        b.style.background = '#6c757d';
                    });
                    e.target.style.background = e.target.dataset.type === 'metadata' ? '#28a745' : '#667eea';
                    analysisType = e.target.dataset.type;
                    
                    const descriptions = {
                        metadata: 'Fast grouping of largest files first - finds biggest space savings across entire library',
                        smart: 'Smart grouping of largest files with basic quality hints but no full image analysis'
                    };
                    document.getElementById('analysis-description').textContent = descriptions[analysisType];
                    updateFilterPreview();
                });
            });
            
            // Start analysis button
            document.getElementById('start-analysis').addEventListener('click', startSmartAnalysis);
            
            // Album creation buttons
            document.getElementById('create-album-btn').addEventListener('click', () => createAlbum());
            document.getElementById('create-album-custom-btn').addEventListener('click', () => createAlbumWithCustomName());
            
            // Initial preview
            updateFilterPreview();
        }
        
        async function updateFilterPreview() {
            try {
                const response = await fetch(`/api/filter-preview?min_size_mb=${minFileSizeMB}`);
                const data = await response.json();
                
                if (data.success) {
                    const filterPreview = document.getElementById('filter-preview');
                    const analysisPreview = document.getElementById('analysis-preview');
                    
                    filterPreview.innerHTML = `üìà ${data.filtered_count.toLocaleString()} photos ‚â•${minFileSizeMB}MB (${data.percentage.toFixed(1)}% of library)`;
                    
                    if (analysisType === 'metadata') {
                        analysisPreview.innerHTML = `Will analyze top ${Math.min(data.filtered_count, 500)} largest files using fast metadata grouping`;
                    } else {
                        analysisPreview.innerHTML = `Will analyze top ${Math.min(data.filtered_count, 200)} largest files with smart grouping`;
                    }
                } else {
                    document.getElementById('filter-preview').textContent = 'Preview unavailable';
                }
            } catch (error) {
                console.log('Preview update failed:', error);
                document.getElementById('filter-preview').textContent = `Preview: ~${minFileSizeMB}MB+ files`;
            }
        }
        
        async function startSmartAnalysis() {
            const startBtn = document.getElementById('start-analysis');
            const progressContainer = document.getElementById('progress-log-container');
            const progressLog = document.getElementById('progress-log');
            const progressCounter = document.getElementById('progress-items-counter');
            
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ Analyzing...';
            
            // Show progress log and clear previous entries
            progressContainer.style.display = 'block';
            progressLog.innerHTML = '';
            progressCounter.textContent = '';
            
            // Start progress polling
            let progressInterval;
            
            try {
                // Start the analysis request (non-blocking)
                const analysisPromise = fetch('/api/smart-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        min_size_mb: minFileSizeMB,
                        analysis_type: analysisType,
                        max_photos: analysisType === 'metadata' ? 500 : 200
                    })
                });
                
                // Start polling for progress updates
                progressInterval = setInterval(async () => {
                    try {
                        const progressResponse = await fetch('/api/progress');
                        const progress = await progressResponse.json();
                        updateProgressLog(progress);
                    } catch (error) {
                        console.warn('Progress update failed:', error);
                    }
                }, 1000); // Poll every second
                
                // Wait for analysis completion
                const response = await analysisPromise;
                const data = await response.json();
                
                if (data.success) {
                    dashboardData = data.dashboard;
                    
                    // Update both the library stats and priority results with new analysis data
                    updateDashboardUI();
                    updatePriorityResults();
                    document.getElementById('priority-results').style.display = 'block';
                    document.getElementById('priority-results').scrollIntoView({ behavior: 'smooth' });
                    
                    // Final progress update
                    progressLog.innerHTML += '<div style="color: #28a745; font-weight: bold; margin-top: 8px;">‚úÖ Analysis completed successfully!</div>';
                } else {
                    // Enhanced error reporting with debug info
                    let errorMsg = data.error || 'Analysis failed';
                    if (data.debug_info) {
                        console.error('Analysis failure debug info:', data.debug_info);
                        errorMsg += '\n\nThis may indicate an issue with the selected photos or filters.';
                    }
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('Analysis failed:', error);
                showError(`Analysis failed: ${error.message}`);
                progressLog.innerHTML += `<div style="color: #dc3545; font-weight: bold; margin-top: 8px;">‚ùå Analysis failed: ${error.message}</div>`;
            } finally {
                // Stop progress polling
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                
                startBtn.disabled = false;
                startBtn.textContent = 'üöÄ Start Smart Analysis';
            }
        }
        
        function updateProgressLog(progress) {
            const progressLog = document.getElementById('progress-log');
            const progressCounter = document.getElementById('progress-items-counter');
            
            if (progress.detail_log && progress.detail_log.length > 0) {
                // Update counter
                if (progress.total_items > 0) {
                    progressCounter.textContent = `${progress.items_processed || 0}/${progress.total_items} items`;
                } else if (progress.total > 0) {
                    progressCounter.textContent = `${progress.progress}/${progress.total} steps`;
                }
                
                // Update log (show latest entries)
                const logHtml = progress.detail_log.map(entry => {
                    // Parse the timestamp and add color coding
                    if (entry.includes('Analyzing image quality:')) {
                        return `<div style="color: #17a2b8;">${entry}</div>`;
                    } else if (entry.includes('Computing quality scores') || entry.includes('visual similarity')) {
                        return `<div style="color: #ffc107;">${entry}</div>`;
                    } else if (entry.includes('completed') || entry.includes('‚úÖ')) {
                        return `<div style="color: #28a745;">${entry}</div>`;
                    } else {
                        return `<div style="color: #e8e8e8;">${entry}</div>`;
                    }
                }).join('');
                
                progressLog.innerHTML = logHtml;
                
                // Auto-scroll to bottom
                progressLog.scrollTop = progressLog.scrollHeight;
            }
        }
        
        function updatePriorityResults() {
            if (!dashboardData || !dashboardData.priority_summary) return;
            generatePriorityGrid(dashboardData.priority_summary);
        }
        
        function generatePriorityGrid(priorityData) {
            const grid = document.getElementById('priority-grid');
            grid.innerHTML = '';
            
            // Priority level configurations
            const priorityConfigs = [
                { level: 'P1', icon: 'üî•', color: '#dc3545', label: 'Highest Priority', desc: 'Largest files, perfect timing' },
                { level: 'P2', icon: '‚ö°', color: '#fd7e14', label: 'Very High', desc: 'Burst photos, large files' },
                { level: 'P3', icon: 'üéØ', color: '#ffc107', label: 'High Priority', desc: 'Good candidates, clear duplicates' },
                { level: 'P4', icon: '‚≠ê', color: '#20c997', label: 'High-Medium', desc: 'Strong indicators' },
                { level: 'P5', icon: 'üí´', color: '#17a2b8', label: 'Medium+', desc: 'Likely duplicates' },
                { level: 'P6', icon: 'üìä', color: '#6f42c1', label: 'Medium', desc: 'Moderate confidence' },
                { level: 'P7', icon: 'üìà', color: '#6610f2', label: 'Medium-Low', desc: 'Some indicators' },
                { level: 'P8', icon: 'üìã', color: '#6c757d', label: 'Low+', desc: 'Weak signals' },
                { level: 'P9', icon: 'üìù', color: '#adb5bd', label: 'Low Priority', desc: 'Minor duplicates' },
                { level: 'P10', icon: 'üìÑ', color: '#dee2e6', label: 'Lowest', desc: 'Scattered photos' }
            ];
            
            priorityConfigs.forEach(config => {
                const rawData = priorityData[config.level] || { count: 0, photo_count: 0, total_savings_mb: 0 };
                const data = { 
                    count: rawData.count, 
                    photos: rawData.photo_count, 
                    savings_mb: rawData.total_savings_mb 
                };
                
                const bucket = document.createElement('div');
                bucket.className = 'priority-bucket';
                bucket.style.borderLeft = `4px solid ${config.color}`;
                bucket.setAttribute('data-priority', config.level);
                
                bucket.innerHTML = `
                    <div class="priority-header">
                        <div class="priority-icon">${config.icon}</div>
                        <div class="priority-title">${config.label}</div>
                    </div>
                    <div class="priority-stats">
                        <div class="priority-stat">
                            <div class="priority-stat-value">${data.count}</div>
                            <div class="priority-stat-label">Clusters</div>
                        </div>
                        <div class="priority-stat">
                            <div class="priority-stat-value">${data.photos}</div>
                            <div class="priority-stat-label">Photos</div>
                        </div>
                        <div class="priority-stat">
                            <div class="priority-stat-value">${(data.savings_mb && typeof data.savings_mb === 'number') ? data.savings_mb.toFixed(1) : '0.0'} MB</div>
                            <div class="priority-stat-label">Savings</div>
                        </div>
                        <div class="priority-stat">
                            <div class="priority-stat-value">${config.desc}</div>
                            <div class="priority-stat-label">${config.level}</div>
                        </div>
                    </div>
                    <button class="analyze-btn ${config.level}" style="background-color: ${config.color}; color: ${config.level === 'P4' || config.level === 'P5' ? '#333' : 'white'};" 
                            onclick="analyzeCluster('${config.level}')" ${data.count === 0 ? 'disabled' : ''}>
                        ${data.count === 0 ? 'No clusters found' : `Analyze ${config.level} (10 groups max)`}
                    </button>
                `;
                
                grid.appendChild(bucket);
            });
        }
        
        async function analyzeCluster(priority) {
            try {
                console.log(`Analyzing ${priority} priority clusters...`);
                
                // Show loading state
                const button = document.querySelector(`.analyze-btn.${priority}`);
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'Loading...';
                
                // Navigate to legacy view with priority filter
                window.location.href = `/legacy?priority=${priority}&limit=10`;
                
            } catch (error) {
                console.error(`Error analyzing ${priority} clusters:`, error);
                showError(`Failed to analyze ${priority} clusters: ${error.message}`);
                
                // Reset button
                const button = document.querySelector(`.analyze-btn.${priority}`);
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        async function createAlbum(customName = null) {
            if (!dashboardData || !dashboardData.priority_summary) {
                showError('No analysis results available. Please run Smart Analysis first.');
                return;
            }
            
            const statusDiv = document.getElementById('album-status');
            const createBtn = document.getElementById('create-album-btn');
            const customBtn = document.getElementById('create-album-custom-btn');
            
            // Collect all photo UUIDs from analysis results that have duplicates
            const photoUuids = [];
            
            // Iterate through priority levels and collect UUIDs of photos marked for deletion
            Object.values(dashboardData.priority_summary).forEach(priorityData => {
                if (priorityData.groups && Array.isArray(priorityData.groups)) {
                    priorityData.groups.forEach(group => {
                        if (group.photos && Array.isArray(group.photos)) {
                            // For each group, add all photos except the recommended one
                            const recommendedUuid = group.recommended_photo_uuid;
                            group.photos.forEach(photo => {
                                if (photo.uuid !== recommendedUuid) {
                                    photoUuids.push(photo.uuid);
                                }
                            });
                        }
                    });
                }
            });
            
            if (photoUuids.length === 0) {
                statusDiv.innerHTML = '<div style="color: #f39c12;">‚ö†Ô∏è No photos marked for deletion found in current analysis</div>';
                return;
            }
            
            // Disable buttons and show loading
            createBtn.disabled = true;
            customBtn.disabled = true;
            createBtn.textContent = '‚è≥ Creating...';
            statusDiv.innerHTML = '<div style="color: #3498db;">üîÑ Creating album...</div>';
            
            try {
                const albumName = customName || `Dedup Analysis - ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
                
                const response = await fetch('/api/create-album', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        photo_uuids: photoUuids,
                        album_name: albumName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ Created album "${result.album_name}" with ${result.photos_added} photos</div>`;
                } else {
                    throw new Error(result.error || 'Album creation failed');
                }
                
            } catch (error) {
                console.error('Album creation failed:', error);
                statusDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to create album: ${error.message}</div>`;
            } finally {
                // Re-enable buttons
                createBtn.disabled = false;
                customBtn.disabled = false;
                createBtn.textContent = 'üìÅ Create Album';
            }
        }
        
        async function createAlbumWithCustomName() {
            const albumName = prompt('Enter album name:', `Dedup Analysis - ${new Date().toLocaleDateString()}`);
            if (albumName && albumName.trim()) {
                await createAlbum(albumName.trim());
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            document.getElementById('loading').style.display = 'none';
            
            // Hide error after 10 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>